# Cell Layout

플래그, 열거형 및 원시 값들을 사용하여 셀 레이아웃을 설계할 수 있으며, 이를 통해 셀을 페이지로 결합하고 페이지들을 트리로 구성할 수 있습니다. 

셀 수준에서는 키 셀과 키-값 셀 간의 구별이 있고,  키 셀은 분리 키를 보유하고 인접한 포인터 사이의 페이지를 가리키는 포인터를 보유합니다. 

키-값 셀은 키와 그에 연결된 데이터 레코드를 보유하며  페이지 내의 모든 셀이 균일하다고 가정합니다

(예: 모든 셀이 키만 보유하거나 키와 값 모두를 보유할 수 있으며, 마찬가지로 모든 셀이 고정 크기 또는 가변 크기 데이터를 보유할 수 있지만 혼합은 없습니다). 

이는 모든 셀에서 메타데이터를 페이지 수준에서 한 번만 저장할 수 있으므로 모든 셀에서 중복되는 것을 피할 수 있습니다. 키 셀을 구성하기 위해 우리가 필요로 하는 것은 다음과 같습니다:

- 셀 유형(페이지 메타데이터에서 추론할 수 있음)
- 키 크기
- 이 셀이 가리키는 자식 페이지의 ID
- 키 바이트

**가변 크기 키 셀 레이아웃은 다음과 같을 수 있습니다(고정 크기의 경우 셀 레벨에 크기 지정자가 없을 것입니다):**

0                           4                          8
+----------------+---------------+-------------+
| [int] key_size | [int] page_id | [bytes] key |
+----------------+---------------+-------------+

고정 크기 데이터 필드를 함께 그룹화한 다음 key_size 바이트를 뒤따르고,  오프셋 계산을 단순화할 수 있습니다. 모든 고정 크기 필드는 정적인, 사전 계산된 오프셋을 사용하여 액세스할 수 있으므로 가변 크기 데이터에 대해서만 오프셋을 계산해야 합니다. 

키-값 셀은 자식 페이지 ID 대신 데이터 레코드를 보유합니다. 그렇지 않으면 그 구조는 유사합니다:

- 셀 유형(페이지 메타데이터에서 추론할 수 있음)
- 키 크기
- 값 크기
- 키 바이트
- 데이터 레코드 바이트

0                        1                            5 ...
+--------------+----------------+
| [byte] flags | [int] key_size |
+--------------+----------------+

5                                9                                   .. + key_size
+------------------+--------------------+----------------------+
| [int] value_size | [bytes] key | [bytes] data_record |
+------------------+--------------------+----------------------+

여기서 오프셋과 페이지 ID 간의 구분에 주목할 수 있습니다. 

페이지는 고정 크기이고 페이지 캐시에 의해 관리되므로 파일에서 실제 오프셋으로 변환하기 위해 나중에 조회 테이블을 사용하여 페이지 ID만 저장하면 됩니다. 

셀 오프셋은 페이지 지역적이며 페이지 시작 오프셋을 기준으로 상대적입니다. 이렇게 함으로써 표현을 더 조밀하게 유지할 수 있는 더 작은 기수 정수를 사용할 수 있습니다.

## 가변 크기 데이터

> 키와 값 모두 가변 크기를 가질 수 있기에 셀 내의 키와 값이 고정 크기를 가져야 할 필요는 없습니다. 그들의 위치는 고정 크기 셀 헤더를 사용하여 오프셋을 계산하고, 키를 찾으려면 헤더를 건너뛰고 key_size 바이트를 읽습니다. 마찬가지로 값을 찾으려면 헤더 플러스 key_size 바이트를 더 건너뛰고 value_size 바이트를 읽을 수 있습니다. 중요한 것은 셀을 하위 부분으로 나누고 인코딩된 데이터를 재구성할 충분한 정보가 있는지입니다.
> 

# Combining Cells into Slotted Pages

셀을 페이지로 구성하기 위해 우리는 "페이지 구조"에서 논의한 슬롯 페이지 기술을 사용할 수 있습니다. 

페이지의 오른쪽 측면(끝 쪽)에 셀을 추가하고, 페이지의 왼쪽 측면에 셀 오프셋/포인터를 유지합니다. 


키는 순서대로 삽입되지 않을 수 있으며, 그들의 논리적으로 정렬된 순서는 키 순서에 따라 셀 오프셋 포인터를 정렬함으로써 유지됩니다.  셀은 삽입, 업데이트 또는 삭제 작업 중에 이동할 필요가 없으므로 최소한의 노력으로 페이지에 셀을 추가할 수 있도록 허용합니다. 
이름을 보유하는 페이지의 예를 살펴보겠습니다. 페이지에는 두 개의 이름이 추가되며, 그들의 삽입 순서는 다음과 같습니다

셀은 삽입 순서대로 레이아웃되지만, 오프셋은 이진 검색을 사용할 수 있도록 재정렬되므로 그들의 논리적인 순서(이 경우 알파벳순)는 삽입 순서(페이지에 추가된 순서)와 일치하지 않습니다. 

[]()

이제 이 페이지에 하나의 이름을 더 추가하려고 합니다: Ron. 새로운 데이터는 페이지의 여유 공간의 상한선에 추가됩니다. 그러나 셀 오프셋은 사전식 키 순서를 보존해야 합니다: Leslie, Ron, Tom. 이를 위해서는 셀 오프셋을 재정렬해야 합니다. 삽입 지점 이후의 포인터들은 Ron 셀을 위한 새로운 포인터에 공간을 만들기 위해 오른쪽으로 이동됩니다. Figure 3-8에서 볼 수 있듯이요.

[]()
